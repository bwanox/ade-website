rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    function isSignedIn() { return request.auth != null; }
    function role() { return isSignedIn() ? request.auth.token.role : null; }
    function isAdmin() { return isSignedIn() && (request.auth.token.admin == true || role() == 'admin'); }
    function isClubRepForClub(clubId) { return isSignedIn() && (role() == 'club_rep' || role() == 'admin') && request.auth.token.clubId == clubId; }

    // Public readable by default for site assets (can be tightened per-path if needed)
    match /{allPaths=**} {
      allow read: if true;
    }

    // Club reps manage their own club assets only
    // Used by ClubRepManager: ImageDropzone pathPrefix `clubs/{clubId}/logo-...`
    match /clubs/{clubId}/{rest=**} {
      allow write: if isAdmin() || isClubRepForClub(clubId);
    }

    // Admin-managed prefixes only (writes)
    match /club_logos/{all=**} { // used by AdminClubManager
      allow write: if isAdmin();
    }
    match /club_board/{slug}/{rest=**} { // used by AdminClubManager board avatars per club slug
      allow write: if isAdmin();
    }
    match /club_achievements/{slug}/{rest=**} { // used by AdminClubManager
      allow write: if isAdmin();
    }
    match /board_members/{rest=**} { // used by AdminBoardManager
      allow write: if isAdmin();
    }
    match /course_hero/{rest=**} { // used by AdminCoursesManager
      allow write: if isAdmin();
    }
    match /course_resources/{rest=**} { // used by AdminCoursesManager
      allow write: if isAdmin();
    }
    match /calendars/{rest=**} { // used by AdminCalendarManager
      allow write: if isAdmin();
    }
    match /news/{rest=**} { // used by AdminNewsManager
      allow write: if isAdmin();
    }

    // Default deny other writes
    match /{any=**} {
      allow write: if false;
    }
  }
}
